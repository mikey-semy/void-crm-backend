#!/bin/bash

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # –ë–µ–∑ —Ü–≤–µ—Ç–∞

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd "$(dirname "$0")/.."
if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é!${NC}"
    exit 1
fi

echo -e "${CYAN}üìÅ –ü–µ—Ä–µ—à–µ–ª –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $(pwd)${NC}"

# –ó–∞–ø—É—Å–∫–∞–µ–º setup.sh
echo -e "${CYAN}‚öôÔ∏è –ó–∞–ø—É—Å–∫–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
./scripts/setup.sh
if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ setup.sh!${NC}"
    exit 1
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -d ".venv" ]; then
    echo -e "${CYAN}üîå –ê–∫—Ç–∏–≤–∏—Ä—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ...${NC}"
    source .venv/bin/activate
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è!${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!${NC}"
else
    echo -e "${RED}‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!${NC}"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–∫–µ—Ä –≤ —Ñ–æ–Ω–µ
echo -e "${CYAN}üîÑ –ó–∞–ø—É—Å–∫–∞—é –≤–æ—Ä–∫–µ—Ä –≤ —Ñ–æ–Ω–µ...${NC}"
uv run worker &
WORKER_PID=$!
echo -e "${GREEN}‚úÖ –í–æ—Ä–∫–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $WORKER_PID)${NC}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Ä–∫–µ—Ä–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo -e "${CYAN}üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤–æ—Ä–∫–µ—Ä...${NC}"
    kill $WORKER_PID 2>/dev/null
    wait $WORKER_PID 2>/dev/null
    echo -e "${GREEN}‚úÖ –í–æ—Ä–∫–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
}
trap cleanup EXIT

# –ó–∞–ø—É—Å–∫–∞–µ–º dev —Ä–µ–∂–∏–º
echo -e "${CYAN}üöÄ –ó–∞–ø—É—Å–∫–∞—é dev —Ä–µ–∂–∏–º...${NC}"
uv run dev
if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ dev —Ä–µ–∂–∏–º–∞!${NC}"
    exit 1
fi
